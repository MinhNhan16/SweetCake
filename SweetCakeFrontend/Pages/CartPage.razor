@page "/cart"
@layout HomeLayout
@inject CartService CartService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@using SweetCakeFrontend.DTO
@using SweetCakeFrontend.Models
@using SweetCakeFrontend.Services

<h3 class="mb-6 text-xl font-semibold">🛒 Quản lý Giỏ hàng</h3>

@if (carts == null)
{
    <p class="text-gray-500">Đang tải dữ liệu...</p>
}
else if (carts.Count == 0)
{
    <p class="text-gray-500">Giỏ hàng của bạn hiện chưa có sản phẩm.</p>
}
else
{
    <div class="overflow-x-auto rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200 bg-white text-sm">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 text-left font-semibold">ID</th>
                    <th class="px-4 py-2 text-left font-semibold">Sản phẩm</th>
                    <th class="px-4 py-2 text-left font-semibold">Số lượng</th>
                    <th class="px-4 py-2 text-left font-semibold">Kích cỡ</th>
                    <th class="px-4 py-2 text-left font-semibold">Giá</th>
                    <th class="px-4 py-2 text-left font-semibold">Tổng giá</th>
                    <th class="px-4 py-2 text-left font-semibold">Ngày tạo</th>
                    <th class="px-4 py-2 text-left font-semibold">Thao tác</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                @foreach (var cart in carts)
                {
                    <tr>
                        <td class="px-4 py-2">@cart.Id</td>
                        <td class="px-4 py-2">@cart.ProductId</td>
                        <td class="px-4 py-2">@cart.Quantity</td>
                        <td class="px-4 py-2">@cart.Size</td>
                        <td class="px-4 py-2 font-semibold text-red-600">@cart.Price.ToString("N0")</td>
                        <td class="px-4 py-2 font-semibold">@cart.TotalPrice.ToString("N0")</td>
                        <td class="px-4 py-2">@cart.DateCreated.ToString("dd/MM/yyyy")</td>
                        <td class="space-x-2 px-4 py-2">
                            <button class="rounded bg-red-500 px-3 py-1 text-sm text-white hover:bg-red-600" @onclick="() => DeleteCart(cart.Id)">Xoá</button>
                            <button class="rounded bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700" @onclick="() => EditCart(cart)">Chỉnh sửa</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (isEditing)
{
    <EditForm Model="currentCart" OnValidSubmit="UpdateCart">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mt-6 space-y-4">
            <h5 class="text-lg font-medium text-gray-700">📝 Cập nhật số lượng</h5>

            <div>
                <label class="block text-sm font-medium">Số lượng:</label>
                <InputNumber class="mt-1 w-full rounded border px-3 py-2" @bind-Value="currentCart.Quantity" />
            </div>

            <div class="space-x-2">
                <button class="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700" type="submit">💾 Lưu</button>
                <button class="rounded bg-gray-400 px-4 py-2 text-white hover:bg-gray-500" type="button" @onclick="ResetForm">Huỷ</button>
            </div>
        </div>
    </EditForm>
}

@code {
    private List<CartDto>? carts;
    private CartDto currentCart = new();
    private bool isEditing = false;

    protected override async Task OnInitializedAsync()
    {
        var accountId = await GetAccountIdFromLocalStorage();

        if (accountId == null)
        {
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            await LoadData(accountId.Value);
        }
    }

    private async Task<int?> GetAccountIdFromLocalStorage()
    {
        var userJson = await JS.InvokeAsync<string>("localStorage.getItem", "currentUser");
        Console.WriteLine($"userJson: {userJson}");

        if (string.IsNullOrEmpty(userJson))
        {
            return null;
        }

        try
        {
            var user = System.Text.Json.JsonSerializer.Deserialize<User>(userJson);
            Console.WriteLine($"Parsed user ID: {user?.Id}");
            return user?.Id;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing user data: {ex.Message}");
            return null;
        }
    }

    private async Task LoadData(int accountId)
    {
        carts = await CartService.GetCartsByAccountIdAsync(accountId);
    }

    private void EditCart(CartDto cart)
    {
        currentCart = cart;
        isEditing = true;
    }

    private async Task UpdateCart()
    {
        var result = await CartService.UpdateAsync(currentCart);
        if (result)
        {
            var accountId = await GetAccountIdFromLocalStorage();
            if (accountId.HasValue)
            {
                await LoadData(accountId.Value);
            }
            ResetForm();
        }
    }

    private async Task DeleteCart(int id)
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", $"Bạn có chắc muốn xoá giỏ hàng #{id}?");
        if (confirm)
        {
            var result = await CartService.DeleteAsync(id);
            if (result)
            {
                var accountId = await GetAccountIdFromLocalStorage();
                if (accountId.HasValue)
                {
                    await LoadData(accountId.Value);
                }
            }
        }
    }

    private void ResetForm()
    {
        currentCart = new CartDto();
        isEditing = false;
    }
}